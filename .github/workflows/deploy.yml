name: Deploy Banco Distribuido

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecutar manualmente

env:
  NODE_VERSION: "20"
  DEPLOY_PATH: "/home/polo/banco-distribuido"

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy and Start Services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸš€ Iniciando deployment..."
            
            # Asegurar que Bun estÃ© en el PATH
            export PATH="$HOME/.bun/bin:$PATH"
            
            # Crear directorio si no existe
            mkdir -p /home/polo/banco-distribuido
            cd /home/polo/banco-distribuido
            
            # Clonar o actualizar repositorio
            if [ -d ".git" ]; then
              echo "ğŸ“¦ Actualizando repositorio..."
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            else
              echo "ğŸ“¦ Clonando repositorio..."
              # Limpiar directorio si existe pero no es git
              rm -rf * .* 2>/dev/null || true
              git clone https://github.com/${{ github.repository }} .
            fi
            
            # Verificar que Bun estÃ© instalado
            if ! command -v bun &> /dev/null; then
              echo "âš ï¸  Bun no encontrado. Instalando..."
              curl -fsSL https://bun.sh/install | bash
              export PATH="$HOME/.bun/bin:$PATH"
            fi
            
            echo "ğŸ“¦ Instalando dependencias..."
            
            # Instalar dependencias del coordinador
            cd coordinador
            bun install
            cd ..
            
            # Instalar dependencias de los workers
            cd worker
            bun install
            
            # Generar Prisma Client
            echo "ğŸ”§ Generando Prisma Client..."
            bunx prisma generate --schema=prisma/schema.prisma
            
            # Ejecutar migraciones de base de datos (solo si es necesario)
            echo "ğŸ—„ï¸  Ejecutando migraciones..."
            bunx prisma migrate deploy --schema=prisma/schema.prisma || echo "âš ï¸  Migraciones no aplicadas"
            
            cd ..            # Instalar PM2 si no estÃ¡ instalado
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Instalando PM2..."
              npm install -g pm2
            fi

            echo "ğŸ›‘ Deteniendo servicios existentes..."
            pm2 delete coordinador worker-3001 worker-3002 worker-3003 2>/dev/null || true

            echo "ğŸš€ Iniciando servicios..."

            # Iniciar Coordinador en puerto 4000
            cd coordinador
            PORT=4000 pm2 start bun --name "coordinador" -- run start
            cd ..

            # Esperar a que el coordinador estÃ© listo
            sleep 3

            # Iniciar Worker 1 en puerto 3001
            cd worker
            PORT=3001 COORDINADOR_URL=http://localhost:4000 pm2 start bun --name "worker-3001" -- run start

            # Iniciar Worker 2 en puerto 3002
            PORT=3002 COORDINADOR_URL=http://localhost:4000 pm2 start bun --name "worker-3002" -- run start

            # Iniciar Worker 3 en puerto 3003
            PORT=3003 COORDINADOR_URL=http://localhost:4000 pm2 start bun --name "worker-3003" -- run start
            cd ..

            # Guardar configuraciÃ³n de PM2
            pm2 save

            # Configurar PM2 para iniciar al reiniciar el servidor
            pm2 startup systemd -u $USER --hp $HOME 2>/dev/null || true

            echo "âœ… Deployment completado!"
            echo ""
            echo "ğŸ“Š Estado de los servicios:"
            pm2 list
            echo ""
            echo "ğŸ“ URLs:"
            echo "  - Coordinador: http://localhost:4000"
            echo "  - Worker 1: http://localhost:3001"
            echo "  - Worker 2: http://localhost:3002"
            echo "  - Worker 3: http://localhost:3003"

      - name: Verificar Health de los servicios
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸ¥ Verificando salud de los servicios..."
            sleep 5

            # Verificar Workers
            for port in 3001 3002 3003; do
              if curl -f http://localhost:$port/api/health > /dev/null 2>&1; then
                echo "âœ… Worker en puerto $port estÃ¡ saludable"
              else
                echo "âŒ Worker en puerto $port no responde"
              fi
            done

            echo ""
            echo "ğŸ“Š Logs recientes de PM2:"
            pm2 logs --lines 10 --nostream

      - name: NotificaciÃ³n de Ã©xito
        if: success()
        run: |
          echo "âœ… Deployment exitoso!"
          echo "ğŸ‰ Coordinador y 3 Workers estÃ¡n corriendo"
