generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== ENUMS ==============

enum EstadoCuenta {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum TipoTransaccion {
  DEPOSITO
  RETIRO
  TRANSFERENCIA
}

enum EstadoTransaccion {
  COMPLETADA
  PENDIENTE
  FALLIDA
}

// ============== MODELOS ==============

model Usuario {
  id           String   @id @default(uuid())
  nombre       String
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cuentas  CuentaBancaria[]
  sesiones Sesion[]

  @@map("usuarios")
}

model Sesion {
  id        String   @id @default(uuid())
  usuarioId String
  jti       String   @unique
  socketId  String?
  createdAt DateTime @default(now())
  expiresAt DateTime

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiresAt])
  @@index([usuarioId, expiresAt])
  @@map("sesiones")
}

model CuentaBancaria {
  id                  String        @id @default(uuid())
  numeroCuenta        String        @unique
  titularCuenta       String
  saldo               Float         @default(0)
  usuarioId           String?
  estado              EstadoCuenta  @default(ACTIVA)
  version             Int           @default(1)
  limiteRetiroDiario  Float         @default(10000)
  limiteTransferencia Float         @default(50000)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  usuario              Usuario?      @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  transaccionesOrigen  Transaccion[] @relation("CuentaOrigen")
  transaccionesDestino Transaccion[] @relation("CuentaDestino")

  @@index([usuarioId])
  @@index([numeroCuenta])
  @@index([estado])
  @@map("cuentas_bancarias")
}

model Transaccion {
  id              String             @id @default(uuid())
  tipo            TipoTransaccion
  monto           Float
  cuentaOrigenId  String?
  cuentaDestinoId String?
  descripcion     String?
  estado          EstadoTransaccion  @default(COMPLETADA)
  referencia      String             @unique @default(cuid())
  createdAt       DateTime           @default(now())

  cuentaOrigen  CuentaBancaria? @relation("CuentaOrigen", fields: [cuentaOrigenId], references: [id], onDelete: SetNull)
  cuentaDestino CuentaBancaria? @relation("CuentaDestino", fields: [cuentaDestinoId], references: [id], onDelete: SetNull)

  @@index([cuentaOrigenId])
  @@index([cuentaDestinoId])
  @@index([createdAt])
  @@index([tipo])
  @@index([estado])
  @@index([cuentaOrigenId, createdAt])
  @@index([estado, createdAt])
  @@map("transacciones")
}
