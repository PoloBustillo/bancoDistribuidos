# NOTA: Esta versi칩n usa una base de datos PostgreSQL EXTERNA
# Para usar PostgreSQL en Docker, usa docker-compose.full.yml

services:
  # Coordinador
  coordinador:
    # Para production: usa image de GHCR
    image: ghcr.io/polobustillo/bancodistribuidos-coordinador:latest
    # Para development local: descomentar build y comentar image
    # build:
    #   context: .
    #   dockerfile: coordinador/Dockerfile
    container_name: banco-coordinador
    environment:
      PORT: 4000
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN:-https://banco-distribuidos.vercel.app}
    ports:
      - "4000:4000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - banco-network

  # Worker 1
  worker-1:
    # Los 3 workers usan la MISMA imagen (mismo c칩digo, diferentes puertos)
    # Para production: usa image de GHCR
    image: ghcr.io/polobustillo/bancodistribuidos-worker:latest
    # Para development local: descomentar build y comentar image
    # build:
    #   context: .
    #   dockerfile: worker/Dockerfile
    container_name: banco-worker-1
    environment:
      PORT: 3001
      COORDINADOR_URL: http://coordinador:4000
      # DATABASE_URL debe apuntar a la BD externa del servidor
      DATABASE_URL: ${DATABASE_URL}
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN:-https://banco-distribuidos.vercel.app}
      # RabbitMQ para notificaciones
      RABBITMQ_URL: amqp://user:password@rabbitmq:5672
      NOTIF_QUEUE: notificaciones
    ports:
      - "3001:3001"
    depends_on:
      coordinador:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - banco-network
    # Usar host network si la BD est치 en localhost del servidor
    # network_mode: "host"  # Descomentar si DATABASE_URL usa localhost

  # Worker 2
  worker-2:
    # Misma imagen que worker-1, solo cambia PORT
    image: ghcr.io/polobustillo/bancodistribuidos-worker:latest
    # Para development local: descomentar build y comentar image
    # build:
    #   context: .
    #   dockerfile: worker/Dockerfile
    container_name: banco-worker-2
    environment:
      PORT: 3002
      COORDINADOR_URL: http://coordinador:4000
      DATABASE_URL: ${DATABASE_URL}
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN:-https://banco-distribuidos.vercel.app}
      # RabbitMQ para notificaciones
      RABBITMQ_URL: amqp://user:password@rabbitmq:5672
      NOTIF_QUEUE: notificaciones
    ports:
      - "3002:3002"
    depends_on:
      coordinador:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - banco-network

  # Worker 3
  worker-3:
    # Misma imagen que worker-1 y worker-2
    image: ghcr.io/polobustillo/bancodistribuidos-worker:latest
    # Para development local: descomentar build y comentar image
    # build:
    #   context: .
    #   dockerfile: worker/Dockerfile
    container_name: banco-worker-3
    environment:
      PORT: 3003
      COORDINADOR_URL: http://coordinador:4000
      DATABASE_URL: ${DATABASE_URL}
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN:-https://banco-distribuidos.vercel.app}
      # RabbitMQ para notificaciones
      RABBITMQ_URL: amqp://user:password@rabbitmq:5672
      NOTIF_QUEUE: notificaciones
    ports:
      - "3003:3003"
    depends_on:
      coordinador:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - banco-network

  # ========================================
  # 游냟 RABBITMQ (Message Broker)
  # ========================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: banco-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-user}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-password}
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - banco-network
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # ========================================
  # 游닎 MICROSERVICIO DE NOTIFICACIONES
  # ========================================
  notificaciones:
    # Para production: usa image de GHCR
    image: ghcr.io/polobustillo/bancodistribuidos-notificaciones:latest
    # Para development local: descomentar build y comentar image
    # build:
    #   context: ./microservicios/notificaciones
    #   dockerfile: Dockerfile
    container_name: banco-notificaciones
    environment:
      PORT: 4001
      GRPC_PORT: 50051
      NODE_ENV: production
      RABBITMQ_URL: amqp://user:password@rabbitmq:5672
      NOTIF_QUEUE: notificaciones
      # Configurar con tu API Key de Resend
      RESEND_API_KEY: ${RESEND_API_KEY}
      RESEND_FROM: ${RESEND_FROM:-"Banco <no-reply@psicologopuebla.com>"}
    ports:
      - "4001:4001"  # HTTP API
      - "50051:50051" # gRPC
    depends_on:
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - banco-network

  # ========================================
  # 游깷 CADDY REVERSE PROXY (OPCIONAL)
  # ========================================
  # Descomentar para usar Caddy como reverse proxy con HTTPS autom치tico
  # Requiere configurar DOMAIN en .env
  # 
  # caddy:
  #   image: caddy:2-alpine
  #   container_name: banco-caddy
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./Caddyfile:/etc/caddy/Caddyfile
  #     - caddy_data:/data
  #     - caddy_config:/config
  #     - caddy_logs:/var/log/caddy
  #   environment:
  #     DOMAIN: ${DOMAIN:-localhost}
  #     CORS_ORIGIN: ${CORS_ORIGIN:-https://banco-distribuidos.vercel.app}
  #   networks:
  #     - banco-network
  #   depends_on:
  #     - coordinador
  #     - worker-1
  #     - worker-2
  #     - worker-3

networks:
  banco-network:
    driver: bridge

# Vol칰menes persistentes
volumes:
  rabbitmq_data:
    driver: local
  # Descomentar si usas Caddy
  # caddy_data:
  # caddy_config:
  # caddy_logs:
