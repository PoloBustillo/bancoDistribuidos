generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum EstadoCuenta {
    ACTIVA
    BLOQUEADA
    CERRADA
}

enum TipoCuenta {
    CHEQUES
    DEBITO
    CREDITO
}

enum TipoTarjeta {
    DEBITO
    CREDITO
}

enum EstadoTarjeta {
    ACTIVA
    BLOQUEADA
    CANCELADA
}

// ========================================
// ðŸŽ“ MODELO: Usuario
// ========================================
// Representa un usuario del sistema bancario.
// RELACIÃ“N con cuentas: MUCHOS-A-MUCHOS
// Un usuario puede tener varias cuentas Y
// una cuenta puede pertenecer a varios usuarios (cuenta conjunta)
// ========================================
model Usuario {
    id           String   @id @default(uuid())
    nombre       String
    email        String   @unique
    passwordHash String
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    // ðŸŽ“ RELACIÃ“N MUCHOS-A-MUCHOS: Usuario â†” Cuenta
    usuarioCuentas UsuarioCuenta[]

    // ðŸŽ“ RELACIÃ“N UNO-A-MUCHOS: Usuario â†’ Tarjetas
    // Cada tarjeta pertenece a UN SOLO usuario (individual)
    tarjetas Tarjeta[]

    sesiones Sesion[]

    // ðŸŽ“ RELACIÃ“N: Usuario â†’ CÃ³digos de verificaciÃ³n para asesores
    verificationCodes VerificationCode[]

    @@map("usuarios")
}

model Sesion {
    id        String   @id @default(uuid())
    usuarioId String
    jti       String   @unique
    createdAt DateTime @default(now())
    expiresAt DateTime

    usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

    @@index([usuarioId])
    @@index([expiresAt])
    @@map("sesiones")
}

// ========================================
// ðŸŽ“ MODELO: CuentaBancaria (Recurso Compartido)
// ========================================
// Una cuenta puede ser compartida entre mÃºltiples usuarios.
// Ejemplo: Cuenta conjunta entre esposos, socios, etc.
// 
// CONCEPTO DE SISTEMAS DISTRIBUIDOS:
// - Recurso compartido que requiere LOCKS para acceso concurrente
// - MÃºltiples usuarios (workers) pueden operar sobre la misma cuenta
// - Necesita sincronizaciÃ³n para evitar race conditions
// ========================================
model CuentaBancaria {
    id           String       @id @default(uuid())
    numeroCuenta String       @unique
    nombre       String // Nombre de la cuenta (ej: "Cuenta Conjunta Familia")
    tipoCuenta   TipoCuenta   @default(CHEQUES)
    saldo        Float        @default(0)
    limiteDiario Float? // LÃ­mite de retiro/transferencia diaria
    estado       EstadoCuenta @default(ACTIVA)
    createdAt    DateTime     @default(now())
    updatedAt    DateTime     @updatedAt

    // ðŸŽ“ RELACIÃ“N MUCHOS-A-MUCHOS: Cuenta â†” Usuario
    usuarioCuentas UsuarioCuenta[]

    // Tarjetas asociadas a esta cuenta
    tarjetas Tarjeta[]

    @@index([numeroCuenta])
    @@map("cuentas_bancarias")
}

// ========================================
// ðŸŽ“ MODELO: UsuarioCuenta (Tabla de UniÃ³n)
// ========================================
// Tabla intermedia para la relaciÃ³n MUCHOS-A-MUCHOS
// entre Usuarios y Cuentas.
// 
// Permite:
// - Un usuario tenga mÃºltiples cuentas
// - Una cuenta tenga mÃºltiples usuarios (cuenta conjunta)
// 
// Campo 'rol' permite definir permisos:
// - TITULAR: Puede hacer cualquier operaciÃ³n
// - AUTORIZADO: Puede hacer retiros/depÃ³sitos pero no cerrar cuenta
// - CONSULTA: Solo puede ver el saldo
// ========================================
model UsuarioCuenta {
    id        String   @id @default(uuid())
    usuarioId String
    cuentaId  String
    rol       String   @default("TITULAR") // TITULAR, AUTORIZADO, CONSULTA
    createdAt DateTime @default(now())

    usuario Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
    cuenta  CuentaBancaria @relation(fields: [cuentaId], references: [id], onDelete: Cascade)

    // ðŸŽ“ RESTRICCIÃ“N: Un usuario no puede estar asociado
    // a la misma cuenta dos veces
    @@unique([usuarioId, cuentaId])
    @@index([usuarioId])
    @@index([cuentaId])
    @@map("usuarios_cuentas")
}

// ========================================
// ðŸŽ“ MODELO: Tarjeta (Recurso Individual)
// ========================================
// Las tarjetas son INDIVIDUALES - pertenecen a un solo usuario.
// Aunque la cuenta sea compartida, cada usuario tiene su propia tarjeta.
// 
// CONCEPTO DE SISTEMAS DISTRIBUIDOS:
// - Recurso NO compartido (individual por usuario)
// - Requiere lock solo para el usuario que la posee
// - Bloqueo/cancelaciÃ³n no afecta tarjetas de otros usuarios
// ========================================
model Tarjeta {
    id              String   @id @default(uuid())
    numeroTarjeta   String   @unique
    cvv             String // En producciÃ³n: encriptar
    fechaExpiracion DateTime

    // ðŸŽ“ RELACIÃ“N: Tarjeta â†’ Usuario (UNO-A-UNO estricto)
    // Una tarjeta pertenece a UN SOLO usuario
    usuarioId String

    // ðŸŽ“ RELACIÃ“N: Tarjeta â†’ Cuenta (MUCHOS-A-UNO)
    // MÃºltiples tarjetas pueden estar asociadas a la misma cuenta
    cuentaId String

    tipoTarjeta  TipoTarjeta
    estado       EstadoTarjeta @default(ACTIVA)
    limiteDiario Float?
    createdAt    DateTime      @default(now())
    updatedAt    DateTime      @updatedAt

    usuario Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
    cuenta  CuentaBancaria @relation(fields: [cuentaId], references: [id], onDelete: Cascade)

    @@index([usuarioId])
    @@index([cuentaId])
    @@index([numeroTarjeta])
    @@map("tarjetas")
}

// ========================================
// ðŸŽ“ MODELO: Asesor (Agente Bancario)
// ========================================
// Representa a los asesores/agentes bancarios que pueden
// acceder a informaciÃ³n de clientes tras verificaciÃ³n.
// Los asesores estÃ¡n pre-autenticados y solo necesitan
// verificar al cliente con Ãºltimos dÃ­gitos + cÃ³digo temporal.
// ========================================
model Asesor {
    id        String   @id @default(uuid())
    nombre    String
    email     String   @unique
    codigo    String   @unique // CÃ³digo de empleado
    activo    Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    sesiones  AsesorSesion[]
    auditLogs AdvisorAuditLog[]

    @@map("asesores")
}

// ========================================
// ðŸŽ“ MODELO: VerificationCode
// ========================================
// CÃ³digos temporales generados por el cliente para
// que el asesor pueda acceder a su informaciÃ³n.
// El cliente genera el cÃ³digo en su app y se lo
// proporciona verbalmente al asesor.
// ========================================
model VerificationCode {
    id        String   @id @default(uuid())
    usuarioId String
    codeHash  String // Hash bcrypt del cÃ³digo (6 dÃ­gitos)
    purpose   String   @default("ADVISOR_ACCESS")
    expiresAt DateTime
    usado     Boolean  @default(false)
    createdAt DateTime @default(now())

    usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

    @@index([usuarioId])
    @@index([expiresAt])
    @@map("verification_codes")
}

// ========================================
// ðŸŽ“ MODELO: AsesorSesion
// ========================================
// Sesiones de asesores con alcance limitado a clientes especÃ­ficos.
// TTL corto (5-30 min) y scope restringido (solo lectura).
// No invalidan las sesiones de usuarios.
// ========================================
model AsesorSesion {
    id                    String   @id @default(uuid())
    asesorId              String
    jti                   String   @unique // JWT ID
    impersonatedUsuarioId String // Cliente que el asesor estÃ¡ atendiendo
    scope                 String   @default("advisor:view") // Permisos separados por comas
    issuedAt              DateTime @default(now())
    expiresAt             DateTime
    ip                    String?
    userAgent             String?
    activo                Boolean  @default(true)

    asesor Asesor @relation(fields: [asesorId], references: [id], onDelete: Cascade)

    @@index([asesorId])
    @@index([impersonatedUsuarioId])
    @@index([expiresAt])
    @@map("asesor_sesiones")
}

// ========================================
// ðŸŽ“ MODELO: AdvisorAuditLog
// ========================================
// Registro de auditorÃ­a de todas las acciones realizadas
// por asesores. CrÃ­tico para compliance y seguridad.
// ========================================
model AdvisorAuditLog {
    id        String   @id @default(uuid())
    asesorId  String?
    usuarioId String? // Cliente afectado
    operacion String // Ej: "VIEW_BALANCE", "VIEW_TRANSACTIONS"
    resource  String? // Recurso especÃ­fico (ej: cuentaId, tarjetaId)
    metadata  Json? // Datos adicionales
    ip        String?
    userAgent String?
    createdAt DateTime @default(now())

    asesor Asesor? @relation(fields: [asesorId], references: [id], onDelete: SetNull)

    @@index([asesorId])
    @@index([usuarioId])
    @@index([createdAt])
    @@map("advisor_audit_logs")
}
